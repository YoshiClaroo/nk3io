<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NK3IO - Mis URLs</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Estilos consistentes con home.html */
    .url-list {
      margin-top: 30px;
    }
    .url-item {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .url-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .url-short {
      color: var(--primary);
      font-weight: 500;
    }
    .url-long {
      color: var(--gray);
      font-size: 0.9rem;
      word-break: break-all;
      margin-bottom: 10px;
    }
    .url-stats {
      display: flex;
      gap: 15px;
      font-size: 0.9rem;
    }
    .stat {
      display: flex;
      align-items: center;
      gap: 5px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <a href="home.html" class="logo">
        <i class="fas fa-link logo-icon"></i>
        <span class="logo-text">NK3IO</span>
      </a>
      <div class="user-menu">
        <img id="userAvatar" src="" alt="Avatar" class="user-avatar">
        <button id="authButton" class="auth-button">
          <i class="fas fa-sign-out-alt"></i>
          <span>Cerrar sesión</span>
        </button>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="container">
      <h2 class="section-title">
        <i class="fas fa-list"></i>
        Mis URLs Acortadas
      </h2>
      
      <div id="urlList" class="url-list">
        <!-- URLs se cargarán aquí -->
      </div>
    </div>
  </main>

  <script type="module">
    import { auth, db, logout } from './js/firebase.js';
    import { 
      collection, query, where, getDocs, orderBy 
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

    const authButton = document.getElementById('authButton');
    const userAvatar = document.getElementById('userAvatar');
    const urlList = document.getElementById('urlList');

    // Configurar logout
    authButton.onclick = logout;

    // Cargar URLs del usuario
    async function loadUserUrls() {
      try {
        const q = query(
          collection(db, "urls"), 
          where("userId", "==", auth.currentUser.uid),
          orderBy("createdAt", "desc")
        );
        
        const querySnapshot = await getDocs(q);
        urlList.innerHTML = '';
        
        querySnapshot.forEach((doc) => {
          const urlData = doc.data();
          const urlItem = document.createElement('div');
          urlItem.className = 'url-item';
          urlItem.innerHTML = `
            <div class="url-header">
              <a href="/redirect.html?id=${urlData.shortId}" class="url-short" target="_blank">
                ${window.location.host}/r/${urlData.shortId}
              </a>
              <div class="url-actions">
                <button class="btn-copy" data-url="${window.location.host}/r/${urlData.shortId}">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            <div class="url-long">${urlData.longUrl}</div>
            <div class="url-stats">
              <div class="stat">
                <i class="fas fa-eye"></i>
                <span>${urlData.clicks || 0} visitas</span>
              </div>
              <div class="stat">
                <i class="fas fa-money-bill-wave"></i>
                <span>$${((urlData.clicks || 0) * 0.005).toFixed(2)}</span>
              </div>
              <div class="stat">
                <i class="fas fa-calendar"></i>
                <span>${urlData.createdAt.toDate().toLocaleDateString()}</span>
              </div>
            </div>
          `;
          urlList.appendChild(urlItem);
        });

        // Configurar botones de copiar
        document.querySelectorAll('.btn-copy').forEach(btn => {
          btn.addEventListener('click', () => {
            navigator.clipboard.writeText(btn.dataset.url);
            btn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
              btn.innerHTML = '<i class="fas fa-copy"></i>';
            }, 2000);
          });
        });

      } catch (error) {
        console.error("Error cargando URLs:", error);
        urlList.innerHTML = '<p>Error al cargar tus URLs. Intenta nuevamente.</p>';
      }
    }

    // Observador de autenticación
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Mostrar avatar si existe
        if (user.photoURL) {
          userAvatar.src = user.photoURL;
        }
        
        // Cargar URLs
        loadUserUrls();
      } else {
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>
